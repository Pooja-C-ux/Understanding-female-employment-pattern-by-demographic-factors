---
title: "plfs_sample_code"
author: "ss"
date: "2025-08-14"
output: pdf_document
---
#----------Outline
#Data wrangling-data cleaning, encoding and subsetting
#Creting categories of demograhic factors-education, mployment category, age group.
#Fidning labor market indicators
#Data visualisation. 
#State maps visualisation.




#Libraries

```{r}
library(tidyverse)
library(readxl)
library(crosstable)
library(descr)
library(survey)
library(sf)
#install.packages("writexl")
library(writexl)
library(ggsci)
library(ggrepel)
library(magrittr)  #multiply by100
library(srvyr)
library(stringr)
```




```{r}
wd<-setwd("C:/Users/LENOVO/OneDrive/writing samples/plfs/plfs_study")

```


#Loading Data
```{r}

plfs_df<-read_csv("./cperv1_jan_dec2024.csv")
state_code<- read_excel("./Data_LayoutPLFS_Calendar_2024.xlsx", sheet = "State code", range = "A2:B38")

plfs_copy<-plfs_df
```


#---------------------Subsetting and standardising data

##Recoding variables
```{r}

#to lower case
names(plfs_copy)<-tolower(names(plfs_copy))

#Subsetting-Required columns
plfs_sub<-plfs_copy %>% 
  select(sec,	st,	ssu,	srl,	rel,	sex,	age,	marst,	gedu_lvl,	tedu_lvl,	form_edu,	curr_att,	pas,	ind_pas,	ocu_pas,	has_sas,	loc_pas,	etyp_pas,	wrkr_pas,	job_pas,	leave_pas,	ssec_pas,	ecoprd_pas,	sas,	ind_sas,	ocu_sas,	loc_sas,	etyp_sas,	wrkr_sas,	job_sas,	leave_sas,	ssec_sas,	ecoprd_sas,	wrk_365,	dur_pas,	dur_sas,	eff_pas,	dur_unp,	evr_wrk,	rea_nw,	rea,	ern_reg,	ern_self,	nss,	nsc,	mult)

#renaming colnames
names(plfs_sub)<-c("sector",	"state_ut_code",	"sample_hh_num",	"person_num",	"relationship",	"sex",	"age",	"marital_status",	"gen_edu_level",	"tec_edu_level",	"num_formal_educ",	"current_attendance",	"principal_status",	"ind_pas",	"ocu_pas",	"has_subsidiary",	"loc_pas",	"etyp_pas",	"wrkr_pas",	"job_type_pas",	"paid_leave_pas",	"social_security_pas",	"ecoprd_pas",	"subsidiary_status",	"ind_sas",	"ocu_sas",	"loc_sas",	"etyp_sas",	"wrkr_sas",	"job_type_sas",	"paid_leave_sas",	"social_security_sas",	"ecoprd_sas",	"wrk_365",	"dur_pas",	"dur_sas",	"eff_pas",	"duration_unp",	"ever_worked",	"reason_notwork",	"reason_principal",	"earning_regular",	"earning_self_emp",	"nss",	"nsc",	"mult")


#-----------------------------------------Recoding
#1.Selecting required variables
plfs_recoded<-plfs_sub %>% 
  select("sample_hh_num",	"person_num",
         "sector","marital_status","sex","state_ut_code","age",
         "gen_edu_level","tec_edu_level",
         "principal_status","has_subsidiary","job_type_pas",	"paid_leave_pas",	"social_security_pas","etyp_sas","etyp_pas","ind_pas","ind_sas",
         "subsidiary_status","job_type_sas",	"paid_leave_sas",	"social_security_sas",
          "ever_worked",	"reason_notwork",	"reason_principal",	"earning_regular",	"earning_self_emp","mult")


#2.Recoding categorical variables
plfs_recoded<-plfs_recoded %>% 
  mutate(across(c("sector","marital_status","sex","state_ut_code",
                  "gen_edu_level","tec_edu_level","etyp_sas","etyp_pas",
                  "principal_status","has_subsidiary","job_type_pas",	"paid_leave_pas",	"social_security_pas",
                  "subsidiary_status","job_type_sas",	"paid_leave_sas",	"social_security_sas",
                  "ever_worked",	"reason_notwork",	"reason_principal"),as.factor)) %>% 
  mutate(sector=fct_recode(sector,"Rural"="1","Urban"="2")) %>% 
  mutate(sex=fct_recode(sex,"Male"="1","Female"="2","third_gender"="3")) %>% 
  mutate(marital_status=fct_recode(marital_status,"Never married"="1","Currently married"= "2",
                                   "Widowed" ="3","Divorced/Separated"="4")) 

#3. Renaming state codes
lookup_vec<-setNames(state_code$`State Name`,state_code$`State Code`)
plfs_recoded<-plfs_recoded %>% 
  mutate(state_ut_code=recode(state_ut_code,!!!lookup_vec))
  

head(plfs_recoded)
```



## Demographic factors
```{r}

#Education Category
plfs_recoded<-plfs_recoded %>% 
  mutate(gen_edu_level=as.numeric(as.character(gen_edu_level))) %>% 
  mutate(educ_cat=case_when(
                 gen_edu_level %in% c(1,2,3,4)~"Illiterate and literate without formal sch",
                            gen_edu_level %in% c(5,6)~"Primary and below primary",
                            gen_edu_level %in% c(7)~"Middle",
                            gen_edu_level %in% c(8)~"Secondary",
                            gen_edu_level %in% c(10)~"Secondary",
                            gen_edu_level %in% c(11)~"diploma",
                            gen_edu_level %in% c(12)~"Graduate",
                            gen_edu_level %in% c(13)~"Post graduate and above")) %>% 
  mutate(educ_cat=factor(educ_cat,
                         levels = c("Illiterate and literate without formal sch",
                                    "Primary and below primary","Middle",
                                    "Secondary","Graduate","Post graduate and above","diploma")))



#Age Category

plfs_recoded<-plfs_recoded %>% 
  mutate(age_cat=case_when(plfs_recoded$age %in% c(15:29)~"young workforce (15-29)",
                           plfs_recoded$age %in% c(30:59)~"Middle Aged (30-50)",
                           plfs_recoded$age >=60 ~"60 and above")) %>% 
  mutate(age_cat=factor(age_cat,
                        levels = c("young workforce (15-29)",
                                   "Middle Aged (30-50)",
                                   "60 and above")))


#Removing rows with sex-third gender which accounts for 15 members
plfs_recoded<-plfs_recoded %>%
  filter(sex!="third_gender")



```


## Labour market status-employed/unemployed
```{r}

#Employed (ps+ss)
plfs_recoded<-plfs_recoded %>% 
  mutate(employed_ps_ss=case_when(principal_status %in% c(11,12,21,31,41,51)|
                              subsidiary_status %in% c(11,12,21,31,41,51)~1,
                            principal_status %in% c(81)~0,
                            TRUE~0))
#Labour force(ps+ss)
plfs_recoded<-plfs_recoded %>% 
  mutate(labourforce_ps_ss=case_when(principal_status %in% c(11,12,21,31,41,51,81)|
                              subsidiary_status %in% c(11,12,21,31,41,51)~1,
                            principal_status %in% c(81)~0,
                            TRUE~0))

#unemployed_
plfs_recoded<-plfs_recoded %>% 
  mutate(unemployed_ps_ss=case_when(principal_status %in% c(81)&
                              !(subsidiary_status %in% c(11,12,21,31,41,51))~1,
                            TRUE~0))




```



```{r}

#-------------Creating Employment and unemployment category

#--------Principal Status
plfs_recoded <-plfs_recoded %>% 
  mutate(employed_principal_cat=case_when(
           principal_status %in% c(11,12)~"Self employed",
           principal_status==21 ~"Unpaid family worker",
           principal_status==31 ~"Regular salaried",
           principal_status %in% c(41,51)~"Casual labour",
          # principal_status==81 ~"Unemployed",
           #principal_status==91~"Enrolled in education",
           principal_status %in% c(81:99)~NA)) 

plfs_recoded<-plfs_recoded %>% 
  mutate(emp_principal_cat_broader=case_when(
    principal_status %in% c(11,12,21,31,41,51)|subsidiary_status %in% c(11,12,21,31,41,51)~"Employed",
    principal_status %in% c(81) & !(subsidiary_status %in% c(11,12,21,31,41,51)) ~"Unemployed",
    principal_status %in% c(91)~"Enrolled in education",
    principal_status %in% c(92,93)~"Attended domestic duties",
    principal_status %in% c(94:99)~"Out of labour force"
  ))

#--------Subsidiary Status

plfs_recoded <-plfs_recoded %>% 
  mutate(employed_sub_cat=case_when(
           subsidiary_status %in% c(11,12)~"Self Employed",
           subsidiary_status==21 ~"Unpaid family worker",
          subsidiary_status==31 ~"Regular salaried",
           subsidiary_status %in% c(41,51)~"Casual_labour")) 



```

#Quality of employment

```{r}
plfs_recoded<-plfs_recoded %>%
  mutate(across (c("etyp_pas","etyp_sas",
                   "job_type_pas","job_type_sas",
                   "paid_leave_pas","paid_leave_sas",
                   "social_security_pas","social_security_sas"),as.character)) %>% 
  mutate(across(c("etyp_pas","etyp_sas",
                   "job_type_pas","job_type_sas",
                   "paid_leave_pas","paid_leave_sas",
                   "social_security_pas","social_security_sas"),as.numeric)) %>% 
  mutate(enterprise_type=case_when(
    etyp_pas %in% c(1,2,3,4,12)|etyp_sas %in% c(1,2,3,4,12)~"Informal",
    etyp_pas %in% c(5,6)|etyp_sas %in% c(5,6)~"Formal-government",
    etyp_pas %in% c(19)| etyp_sas %in% c(19)~"Others",
    etyp_pas %in% c(7,8,10,11)| etyp_sas %in% c(7,8,10,11)~"Formal-private"
  )) %>% 
   mutate(job_type=case_when(
    job_type_pas==1|job_type_sas==1~"No job contract",
    job_type_pas==2|job_type_sas==2~"1 year or less",
    job_type_pas==3|job_type_sas==3~"1 to 3 years",
    job_type_pas==4|job_type_sas==4~"More than 3 years"
    )) %>% 
   mutate(social_security=case_when(
    social_security_pas %in% c(1:7)|social_security_sas %in% c(1:7)~"Eligible",
    social_security_pas==8 & social_security_sas==8~"Not eligible",
    TRUE~NA)) %>% 
  mutate(paid_leave=case_when(
    paid_leave_pas==1|paid_leave_sas==1~"Eligible",
    paid_leave_pas==2 & paid_leave_sas==2~"Not eligible",
  ))
 



```


```{r}
#Anything starting with 01 to 03 -agricultural
#10-33

is.character(plfs_copy$ind_pas)

plfs_recoded<-plfs_recoded %>% 
  mutate(industry=case_when(
    str_detect(ind_pas,"^0[1-3]")~"Agriculture",
    str_detect(ind_pas, "^0[5-9]|^[1-3][0-9]|^4[0-3]") ~ "Secondary",       
    str_detect(ind_pas,"^4[4-9]|^[5-9][0-9]") ~ "Tertiary",   
  ))
```



#------------------------EStimates----------------------

```{r}
#Selecting only population above 15 years of age
plfs_dt<-plfs_recoded %>% 
  filter(age>=15)

#Assigning weights
srv <- plfs_dt %>% as_survey_design(weights = mult)

```




#--------------------Distribution
```{r}

activity_distribution<-srv %>% 
  group_by(sex,emp_principal_cat_broader) %>%
  summarize(activity_distribution=round(100*(survey_prop(vartype =NULL,na.rm = TRUE)),1))

employment_distribution<-srv %>% 
  filter(!is.na(employed_principal_cat)) %>% 
  group_by(sex,employed_principal_cat) %>%
  summarize(emp_distribution=round(100*(survey_prop(vartype =NULL,na.rm = TRUE)),1))

employment_distribution_sec<-srv %>% 
  filter(!is.na(employed_principal_cat)) %>% 
  group_by(sector,sex,employed_principal_cat) %>%
  summarize(emp_distribution=round(100*(survey_prop(vartype =NULL,na.rm = TRUE)),1))

education<-srv %>% 
  group_by(sex,educ_cat) %>% 
  summarize(education_distribution=round(100*survey_prop(vartype =NULL,na.rm = TRUE),2))

```


#-------------------------Labour market indicators

```{r}

#Overall
lb_mkt_indicators_overall <- srv %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1)  )

#Labour Market indicators by sex
lb_mkt_indicators_sex <- srv %>%
  group_by(sex) %>% 
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1)  )

#Labour Market indicators by sex and sector
lb_mkt_indicators_sex_sec <- srv %>%
  group_by(sex,sector) %>% 
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1))

#Labour _mkt_indicators by sex and educational category
lb_mkt_indicators_edu_sex <- srv %>%
  group_by(sex, educ_cat) %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1)
    )

#Labour Market Indicators by age cat

lb_mkt_indicators_age_cat <- srv %>%
  group_by(sex, age_cat) %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * (survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE)), 2))

#Labour Market indicators by State
lb_mkt_indicators_state <- srv %>%
  group_by(sex, state_ut_code) %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1)
    )

#Youngworkforce by state
lb_mkt_indicators_state_young <- srv %>%
  filter(age_cat=="young workforce (15-29)") %>% 
  group_by(sex,state_ut_code) %>%
  summarize(
   unemployment_rate_young = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1))

#Labour Market indicators by marital status
lb_mkt_indicators_marital <- srv %>%
  group_by(sex,marital_status) %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE), 1)
    )



lb_mkt_indicators_age_cat_educ <- srv %>%
  group_by(age_cat,educ_cat,sex) %>%
  summarize(
    employment_rate = round(100*(survey_mean(employed_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   labourforce_rate=round(100*(survey_mean(labourforce_ps_ss,vartype = NULL, na.rm = TRUE)),1),
   unemployment_rate = round(100 * (survey_ratio(unemployed_ps_ss, 
                                             employed_ps_ss +  unemployed_ps_ss,vartype =
                                               NULL,na.rm = TRUE)), 1))


lb_mkt_edu_emp_cat<-srv %>% 
  filter(!is.na(employed_principal_cat)) %>% 
  group_by(sex,educ_cat,employed_principal_cat)%>% 
 summarize(emp_distribution=round(100*(survey_prop(vartype =NULL,na.rm = TRUE)),1))



```




#------------------------Result tables 
```{r}
write_xlsx(
  list(Sheet1=lb_mkt_indicators_sex,
       Sheet2=lb_mkt_indicators_sex_sec,
       Sheet3=lb_mkt_indicators_overall,
       Sheet4=lb_mkt_indicators_age_cat),
  path = "./results/lb_mkt_indicators.xlsx"
)
```


#-----------------Data Visualisation
```{r}

#------Activity Distribution
p1<-activity_distribution %>% 
ggplot(aes(x=emp_principal_cat_broader,y=activity_distribution,fill = sex))+
  geom_col()+
  facet_wrap(~sex)+
  coord_flip(ylim = c(0, 100)) +
  theme_minimal()+
  labs(x="Activity status",
       y="Percentage of distribution",
       title = "Chart 1-Distribution of population by activity status (ps+us)",
       fill="Gender")+
  geom_text(aes(label = activity_distribution),size = 4,hjust=-0.6)+
  theme_minimal()+
  theme(axis.text.x = element_text(face = "bold",size = 12),
        axis.text.y = element_text(face = "bold",size = 12))+
theme(panel.spacing = unit(1, "cm")) 

ggsave("./results/activity_distribution.jpeg",p1,width = 8,height = 7)


#Employment Distribution
#Overall
p2<-employment_distribution %>% 
ggplot(aes(x=sex,y=emp_distribution,fill = employed_principal_cat))+
  geom_col(position = "stack",width=0.5)+
  geom_text(aes(label = emp_distribution), 
            position = position_stack(vjust = 0.5), 
            color = "black", size = 4)+
     labs(x="The type of employment",
       y="Percentage of distribution",
       title = "Chart 2- The type of employment by gender",
       fill="Employment Category")+
  theme_minimal()+
    theme(legend.position = "bottom",
          axis.text.x = element_text(face = "bold",size = 12),
        axis.text.y = element_text(face = "bold",size = 12))+
guides(fill = guide_legend(nrow = 2, byrow = TRUE))

 

ggsave("./results/employment_distribution.jpeg",p2)




#stacked bar-gen  
p3<-employment_distribution_sec %>% 
ggplot(aes(x=sex,y=emp_distribution,fill = employed_principal_cat))+
  geom_col(position = "stack",width=0.5)+
  facet_grid(~sector)+
  geom_text(aes(label = emp_distribution), 
            position = position_stack(vjust = 0.5), 
            color = "black", size = 4)+
  theme_minimal()+
   labs(x="The type of employment",
       y="Percentage of distribution",
       title = "Chart 3- The type of employment by gender and region",
       fill="Employment Category")+
      theme(legend.position = "bottom",
          axis.text.x = element_text(face = "bold",size = 12),
        axis.text.y = element_text(face = "bold",size = 12))+
guides(fill = guide_legend(nrow = 2, byrow = TRUE))

ggsave("./results/employment_distribution_sec_gen.jpeg",p3)
```


```{r}


#Labour force partici[ation by sex and education]
p4<-lb_mkt_indicators_edu_sex %>% 
  ggplot(aes(x=educ_cat,y=employment_rate,fill=sex))+
  geom_col()+
  facet_wrap(~sex)+
  geom_text(aes(label = employment_rate), 
            position = position_stack(vjust = 1.2), 
            color = "black", size =4)+
   theme_minimal()+
  coord_flip()+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90,hjust = 1),
        axis.text.y = element_text(face = "bold",size = 11))+
  labs(x="Education Category",
       y="Worker population ratio",
       title="Chart 5 Worker population ratio 
       \n by education and gender")

ggsave("./results/female_labouforc_edu.jpeg",p4)


```

```{r}

#WPR
lb_mkt_edu_emp_cat %>% 
 filter(sex=="Male") %>% 
  ggplot(aes(x=educ_cat,y=emp_distribution,fill=employed_principal_cat))+
  geom_col()+
  geom_text(aes(label = emp_distribution),position = position_stack(vjust = 0.5), color = "black")+
   theme_minimal()+
  coord_flip()+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90,hjust = 1))+
  labs(x="Education Category",
       y="Employment Category",
       title="Chart 4a-The nature of employment by educational level- Male")


p8<-lb_mkt_edu_emp_cat %>% 
  filter(sex=="Female") %>% 
  ggplot(aes(x=educ_cat,y=emp_distribution,fill=employed_principal_cat))+
  geom_col()+
  geom_text(aes(label = emp_distribution),position = position_stack(vjust = 0.5), color = "black",size=3)+
   theme_minimal()+
  coord_flip()+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90,hjust = 1),
         axis.text.y = element_text(face = "bold",size = 8))+
  labs(x="Education Category",
       y="Employment Category",
       title="Chart 6-The nature of employment(ps) by 
       \n educational level- Female",
       fill="Employment category")+
 guides(fill = guide_legend(nrow = 2, byrow = TRUE,size=2))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15))


ggsave("./results/female_emp_edu.jpeg",p8)
```

```{r}
#Unemployment rate-age_cat_sex_educ
p5<-lb_mkt_indicators_age_cat_educ %>% 
  filter(age_cat=="young workforce (15-29)") %>% 
  ggplot(aes(x=educ_cat,y=unemployment_rate,fill=sex))+
  geom_col()+
  facet_wrap(~sex)+
  geom_text(aes(label = unemployment_rate), 
            position = position_stack(vjust = 1.5), 
            color = "black", size = 4)+
   theme_minimal()+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90,hjust = 1,
                                   face = "bold"))+
  labs(x="Education Category",
       y="Unemployment rate",
       title = "Chart 7-Unemployment rate of young workforce by education and gender")+
  coord_flip()+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

ggsave("./results/unemprate.jpeg",p5)




```


#-----------------------------STATE ANALYSIS

```{r}

#-------India States geoson map-------
india_states <- st_read("https://raw.githubusercontent.com/india-in-data/india_maps/master/india_state_ut_administered.geojson")

#Getting similar names of states
india_states <- india_states %>%
  mutate(state = recode(
NAME_1,
"Andaman and Nicobar"="Andaman & N. Island",
"Dadra and Nagar Haveli"="D & N. Haveli & Daman & Diu",
"Jammu and Kashmir"="Jammu & Kashmir",
"Puducherry"="Puduchery",
"Tamil Nadu"="Tamilnadu",
"NCT of Delhi"="Delhi",.default = NAME_1 ))


#----
#Labour indicators by state
lb_mkt_indicators_state_copy<-data.frame(lb_mkt_indicators_state ,lb_mkt_indicators_state_young$unemployment_rate_young)

lb_mkt_indicators_state_copy<-lb_mkt_indicators_state_copy %>% 
  rename("Unemployment_rate_young"="lb_mkt_indicators_state_young.unemployment_rate_young")

#State Map
state_map<-india_states %>% 
  select(NAME_1,geometry,state)

#Merging state and labour market
merged_state_lb<- state_map %>%
  left_join(lb_mkt_indicators_state_copy, by = c("state" = "state_ut_code")) 

#Filtering union territories
merged_state_lb<-merged_state_lb %>% 
  filter(!state %in% c("Delhi","Lakshadweep" ,"Andaman & N. Island","D & N. Haveli & Daman & Diu", "Daman and Diu","Chandigarh","Puduchery"))


#Getting state and rates in single column
merged_state_lb<-merged_state_lb %>% 
  mutate(label_emp = paste0(state, "\n", employment_rate)) %>% 
  mutate(label_unemp = paste0(state, "\n", unemployment_rate)) %>% 
  mutate(label_lb = paste0(state, "\n", labourforce_rate)) %>% 
  mutate(label_unemp_young = paste0(state, "\n", Unemployment_rate_young))

```



#State Maps

```{r}
#Employment Rate--FEMALE

state_fem_func<-function(rate,label){
merged_state_lb %>% 
  filter(sex=="Female") %>% 
ggplot()+
  geom_sf(aes(fill = {{rate}}), color = "white") +
   geom_text_repel(
    aes(label = {{label}}, geometry = geometry),
    stat = "sf_coordinates",
    size = 3,
    min.segment.length = 0,
    max.overlaps = Inf
  )+
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
    labs(fill = "(in %)")+
  theme_void() +
  theme(legend.position = "bottom")+
  theme(panel.background = element_rect(fill = "lightblue", color = NA))
}


fem_p1<-state_fem_func(employment_rate,label_emp)+ggtitle("Female worker population rate  by State (Jan-Dec 2024) ")

fem_p2<-state_fem_func(labourforce_rate,label_lb)+ggtitle("Female labourforce rate  by State (Jan-Dec 2024) ")

fem_p3<-state_fem_func(unemployment_rate,label_unemp)+
  ggtitle("Female unemployment rate  by State (Jan-Dec 2024) ")+
  scale_fill_viridis_c(option = "viridis", na.value = "grey90")

fem_p4<-state_fem_func(Unemployment_rate_young,label_unemp_young)+
  ggtitle("Female unemployment rate of young workforce  by State (Jan-Dec 2024) ")+
  scale_fill_viridis_c(option = "viridis", na.value = "grey90")



```


#Unemployment rate for Male

```{r}

state_fem_func_male<-function(rate,label){
merged_state_lb %>% 
  filter(sex=="Male") %>% 
ggplot()+
  geom_sf(aes(fill = {{rate}}), color = "white") +
   geom_text_repel(
    aes(label = {{label}}, geometry = geometry),
    stat = "sf_coordinates",
    size = 3,
    min.segment.length = 0,
    max.overlaps = Inf
  )+
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  theme_minimal() +
    labs(fill = "(in %)")+
  theme_void() +
  theme(legend.position = "bottom")+
  theme(panel.background = element_rect(fill = "lightblue", color = NA))
}


male_p1<-state_fem_func_male(employment_rate,label_emp)+ggtitle("Male worker population rate  by State (Jan-Dec 2024) ")
male_p2<-state_fem_func_male(labourforce_rate,label_lb)+ggtitle("Male labourforce rate  by State (Jan-Dec 2024) ")

male_p3<-state_fem_func_male(unemployment_rate,label_unemp)+
  ggtitle("Male unemployment rate \n by State (Jan-Dec 2024) ")+
  scale_fill_viridis_c(option = "viridis", na.value = "grey90")

male_p4<-state_fem_func_male(Unemployment_rate_young,label_unemp_young)+
  ggtitle("Male unemployment rate of young workforce  by State (Jan-Dec 2024) ")+
  scale_fill_viridis_c(option = "viridis", na.value = "grey90")
```


```{r}

#Saving jpeg

var<-c("fem_p1","fem_p2","fem_p3","fem_p4",
       "male_p1","male_p2","male_p3","male_p4")
for( p in var){
   filename <- paste0("./results/", p, ".jpeg")
   ggsave(filename = filename,  plot = get(p))
}

```






#--------------------------------------Apendix

```{r}



plot_func<-function(df,var){
 
pt1<-ggplot(df,aes(x={{var}},y=employment_rate))+
  geom_col(position = "stack")+
  facet_grid(~sex)+
  geom_text(aes(label = employment_rate), 
            position = position_stack(vjust = 0.5), 
            color = "white", size = 3)+
  coord_flip()+
  theme_minimal()


pt2<-ggplot(df,aes(x={{var}},y=unemployment_rate))+
  geom_col(position = "stack")+
  facet_grid(~sex)+
  geom_text(aes(label = unemployment_rate), 
            position = position_stack(vjust = 0.5), 
            color = "white", size = 3)+
  coord_flip()+
  theme_minimal()


pt3<-ggplot(df,aes(x={{var}},y=labourforce_rate))+
  geom_col(position = "stack")+
  facet_grid(~sex)+
  geom_text(aes(label = labourforce_rate), 
            position = position_stack(vjust = 0.5), 
            color = "white", size = 3)+
  coord_flip()+
  theme_minimal()

print(pt1)
print(pt2)
print(pt3)
}
```



```{r}
plot_func(lb_mkt_indicators_age_cat,age_cat)

plot_func(lb_mkt_indicators_edu_sex,educ_cat)

plot_func(lb_mkt_indicators_marital,marital_status)
```


